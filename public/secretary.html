<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RouteKeeper - Secretary Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; }
        .container { max-width: 900px; } /* Standardized width */
        .stop-card {
            border-left: 5px solid #6f42c1; /* Purple indicator for secretary */
            margin-bottom: 15px;
        }
        .kid-badge {
            font-size: 1.1rem;
            margin-right: 5px;
        }
        .message-box {
            background-color: #e9ecef;
            border-radius: 8px;
            padding: 15px;
        }

        /* Custom Darker Yellow for Accessibility */
        .alert-warning {
            background-color: #fff8e1; /* Lighter yellow background */
            border-color: #ffecb3;
            color: #8a6d3b; /* Darker text for contrast */
        }
        /* Style for unread conversation cards */
        .conversation-card.unread .card-header {
            background-color: #e9f5ff; /* A light blue to indicate unread */
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.5); /* A subtle glow */
        }
        /* New Icon Styles for Read/Unread Messages */
        .envelope-icon {
            font-size: 1.2rem;
            margin-right: 8px;
            vertical-align: -0.1em; /* Better alignment with text */
            transition: color 0.3s ease;
        }
        .envelope-unread {
            color: #0d6efd; /* Bootstrap primary blue */
            text-shadow: 0 0 10px rgba(0, 123, 255, 0.8); /* Glow effect */
        }
        .envelope-read {
            color: #6c757d; /* Bootstrap secondary grey */
        }
        /* Presence badge styles */
        .kid-badge {
            font-size: 1.1rem;
            margin-right: 5px;
            border-radius: 0.375rem;
            padding: 0.35rem 0.55rem;
        }
        .kid-badge.outline {
            background-color: transparent;
            color: #198754; /* bootstrap success */
            border: 1px solid #198754;
        }
        .kid-badge.solid {
            background-color: #198754;
            color: #fff;
            border: 1px solid #198754;
        }
        .kid-badge.clickable { cursor: pointer; }
        .presence-legend { margin-bottom: 0.75rem; }
    </style>
</head>
<body>

<nav id="main-navbar" class="navbar navbar-dark bg-dark mb-3">
    <div class="container-fluid container">
        <span class="navbar-brand mb-0 h1">RouteKeeper</span>
        <button class="btn btn-sm btn-outline-light" onclick="logout()">Logout</button>
    </div>
</nav>

<div id="admin-nav-container"></div>

<div class="container">
    
    <!-- Rider Invite Section -->
    <div class="card shadow-sm mt-4 mb-4">
        <div class="card-body">
            <h5 class="text-secondary">Invite a New Rider</h5>
            <p class="small text-muted">Send a sign-up link to a new rider. They can fill out their own details.</p>
            <form id="invite-form">
                <input type="email" id="invite-email" class="form-control mb-2" placeholder="Rider's email address" required>
                <button type="submit" class="btn btn-info w-100"><i class="bi bi-send-fill"></i> Send Invite</button>
            </form>
            <div id="invite-status" class="mt-2 text-center small"></div>
        </div>
    </div>
    <div class="card shadow-sm message-box mb-4">
        <h5 class="text-secondary">Global Announcement</h5>
        <textarea id="messageText" class="form-control mb-3" rows="3" placeholder="Type message to all active riders..."></textarea>
        <button class="btn btn-primary w-100" id="sendMessageBtn" onclick="sendGlobalMessage()">
            <i class="bi bi-chat-dots-fill"></i> Send Message to All Active Riders
        </button>
        <div id="globalMessageStatus" class="mt-2 text-center small"></div>
    </div>

    <!-- Recent Announcements Section -->
    <div id="recent-announcements-section" class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="d-flex align-items-center">
                <i class="bi bi-megaphone-fill fs-4 me-2 text-secondary"></i>
                <h5 class="mb-0 text-secondary">Recent Announcements</h5>
            </div>
            <button class="btn btn-sm btn-outline-secondary" onclick="clearAnnouncements()">Clear All Announcements</button>
        </div>
        <div id="announcements-list"></div>
    </div>

    <!-- Generate Route Buttons -->
    <div class="d-flex justify-content-between gap-2 my-4">
        <button id="generatePickupRouteBtn" class="btn btn-success btn-lg flex-fill" onclick="generatePickupRoute()" disabled>
            <i class="bi bi-map-fill"></i> Start Pick Ups
        </button>
        <button id="generateDropoffRouteBtn" class="btn btn-success btn-lg flex-fill" onclick="generateDropoffRoute()" disabled>
            <i class="bi bi-map-fill"></i> Start Drop Offs
        </button>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="text-muted" id="dateDisplay">Loading Date...</h5> 
    </div>

    <!-- Attractive Heading -->
    <div class="d-flex justify-content-between align-items-center mb-3 pt-2 border-top">
        <div class="d-flex align-items-center">
            <i class="bi bi-bus-front-fill fs-4 me-2 text-primary"></i>
            <h4 class="mb-0 text-secondary">Active Route Stops</h4>
        </div>
        <!-- Presence legend: outline = coming, solid = on bus -->
        <div class="presence-legend text-end">
            <small class="text-muted">Legend:</small>
            <span class="badge kid-badge outline ms-2">Coming</span>
            <span class="badge kid-badge solid ms-1">On Bus</span>
        </div>
        <button class="btn btn-primary btn-sm" onclick="loadRoute()">Refresh List</button>
    </div>

    <div id="loading" class="text-center mt-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div id="routeList" class="pb-5">
        </div>
    
    <div id="emptyState" class="text-center mt-5 d-none">
        <h3 class="text-muted">No riders found.</h3>
    </div>

    <!-- Rider Messages Section (Moved Here) -->
    <div id="rider-messages-section" class="mb-5">
        <div class="d-flex align-items-center mb-3 pt-2 border-top">
            <i class="bi bi-envelope-fill fs-4 me-2 text-primary"></i>
            <h4 class="mb-0 text-secondary">Rider Messages</h4>
        </div>
        <div id="conversations-list"></div>
    </div>

</div>

<footer class="text-center text-muted py-4">
    <small>&copy; Church and Family Media</small>
</footer>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to permanently delete this announcement?</p>
                <p class="text-danger small">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">Yes, Delete</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // ---------------------------------------------------------
    // 1. SECURITY & SETUP
    // ---------------------------------------------------------
    
    // Define token and role at the top level of the script
    const token = localStorage.getItem('token');
    const role = localStorage.getItem('role');

    // Track present students (on bus). Persisted in localStorage so toggles survive reloads.
    const presentStudentIds = new Set(JSON.parse(localStorage.getItem('presentStudentIds') || '[]'));

    function savePresentStudents() {
        localStorage.setItem('presentStudentIds', JSON.stringify(Array.from(presentStudentIds)));
    }

    function studentIsPresent(studentId) {
        return presentStudentIds.has(studentId);
    }

    function toggleStudentPresence(studentId, element) {
        if (!studentId) return;
        if (presentStudentIds.has(studentId)) {
            presentStudentIds.delete(studentId);
        } else {
            presentStudentIds.add(studentId);
        }
        savePresentStudents();
        // Update DOM classes
        if (element) {
            element.classList.toggle('outline');
            element.classList.toggle('solid');
            // Update tooltip/title
            element.title = studentIsPresent(studentId) ? 'Click to mark as not on bus' : 'Click to mark as on bus';
        } else {
            // If no element provided, attempt to find it
            const badge = document.querySelector(`[data-student-id="${studentId}"]`);
            if (badge) {
                badge.classList.toggle('outline');
                badge.classList.toggle('solid');
                badge.title = studentIsPresent(studentId) ? 'Click to mark as not on bus' : 'Click to mark as on bus';
            }
        }
    }

    // CLIENT-SIDE SECURITY CHECK: This runs immediately on page load
    if (!token || !['secretary', 'admin'].includes(role)) {
        localStorage.clear(); // Clear invalid session data
    window.location.href = '/index.html';
    }

    // Centralized fetch function to handle authentication and errors
    async function fetchWithAuth(url, options = {}) {
        const headers = {
            ...options.headers,
            'Authorization': `Bearer ${token}`
        };

        if (options.body && !headers['Content-Type']) {
            headers['Content-Type'] = 'application/json';
        }

        const response = await fetch(url, { ...options, headers });

        if (response.status === 401 || response.status === 403) {
            logout(); // Token is invalid or expired
        }
        return response;
    }

    // Conditionally render Admin Navbar
    if (role === 'admin') {
        document.getElementById('main-navbar').remove(); // Remove the default navbar
        const adminNavHtml = `
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container">
                <a class="navbar-brand" href="admin-dashboard.html"><i class="bi bi-shield-lock-fill"></i> RouteKeeper Admin</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#adminNavbar">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="adminNavbar">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item"><a class="nav-link" href="admin-dashboard.html">Dashboard</a></li>
                        <li class="nav-item"><a class="nav-link" href="admin-add-user.html">Add User</a></li>
                        <li class="nav-item"><a class="nav-link" href="admin-manage-users.html">Manage Users</a></li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle active" href="#" role="button" data-bs-toggle="dropdown">App Views</a>
                            <ul class="dropdown-menu dropdown-menu-dark">
                                <li><a class="dropdown-item active" href="secretary.html">Secretary View</a></li>
                                <li><a class="dropdown-item" href="driver.html">Driver View</a></li>
                            </ul>
                        </li>
                    </ul>
                    <button class="btn btn-sm btn-outline-light" onclick="logout()">Logout</button>
                </div>
            </div>
        </nav>
        `;
        document.getElementById('admin-nav-container').innerHTML = adminNavHtml;
    }

    function logout() {
        localStorage.clear();
    window.location.href = '/index.html';
    }

    // Variables for the delete confirmation modal
    let messageIdToDelete = null;
    const confirmDeleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));


    // Utility Function to calculate Next Sunday
    function getNextSunday() {
        const d = new Date();
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? 0 : 7); 
        const nextSundayDate = new Date(d.setDate(diff));
        nextSundayDate.setHours(0, 0, 0, 0);
        return nextSundayDate;
    }
    
    const nextSunday = getNextSunday();
    let tempAddresses = []; // Global variable to store temporary addresses
    let activeFamilies = []; // This MUST be a global variable for the route generation functions to access
    const dateOptions = { weekday: 'long', month: 'short', day: 'numeric' };
    const dateDisplayElement = document.getElementById('dateDisplay');
    if (dateDisplayElement) {
        dateDisplayElement.innerText = nextSunday.toLocaleDateString('en-US', dateOptions);
    } 

    // ---------------------------------------------------------
    // 2. MAIN LOGIC: loadRoute() - (Same as Driver.html)
    // ---------------------------------------------------------

    async function loadRoute() {
        const loading = document.getElementById('loading');
        const listContainer = document.getElementById('routeList');
        const emptyState = document.getElementById('emptyState');
        const generatePickupBtn = document.getElementById('generatePickupRouteBtn');
        const generateDropoffBtn = document.getElementById('generateDropoffRouteBtn');
        
        document.getElementById('conversations-list').innerHTML = ''; // Clear conversations
        if (loading) loading.classList.remove('d-none');
        listContainer.innerHTML = ''; 
        if (emptyState) emptyState.classList.add('d-none');
        activeFamilies = []; // Reset the global list of active families on each load

        try {
            const dateStr = nextSunday.toISOString();

            // Check if this date is a non-operational day
            const nonOpCheck = await fetchWithAuth(`/api/calendar/nonop-check?date=${dateStr}`);
            const nonOpData = await nonOpCheck.json();
            
            if (nonOpData.isNonOp) {
                // Display non-op message and hide rider list
                if (loading) loading.classList.add('d-none');
                listContainer.innerHTML = `
                    <div class="alert alert-warning text-center" role="alert">
                        <h4 class="alert-heading"><i class="bi bi-exclamation-triangle-fill"></i> Service Suspended</h4>
                        <p class="mb-0"><strong>${nonOpData.occasion}</strong></p>
                        <hr>
                        <p class="mb-0 small">No riders will be picked up on this date.</p>
                    </div>
                `;
                generatePickupBtn.disabled = true;
                generateDropoffBtn.disabled = true;
                return;
            }

            // A. Fetch All Riders (Families)
            const userRes = await fetchWithAuth('/api/users?role=rider'); 
            const allFamilies = await userRes.json();

            // B. Fetch all relevant data in parallel
            const [exclRes, tempAddrRes] = await Promise.all([
                fetchWithAuth(`/api/exclusions/all?date=${dateStr}`),
                fetchWithAuth(`/api/temporary-address?date=${dateStr}`) // Fetch all temp addresses for the day
            ]);
            const exclusions = await exclRes.json(); 
            tempAddresses = await tempAddrRes.json(); // Assign to global variable

            // D. Fetch global announcements
            fetchAndRenderAnnouncements();

            const excludedStudentIds = exclusions.map(e => e.studentId.toString());
            const conversationPromises = [];

            let activeStopCount = 0;

            // C. Process the Families
            allFamilies.forEach(family => {
                const studentsArray = family.students || [];

                // Filter out students whose ID is in the excluded list
                const activeKids = studentsArray.filter(student => 
                    !excludedStudentIds.includes(student._id.toString()) 
                );

                // If at least one kid is coming, show the card
                if (activeKids.length > 0) {
                    activeStopCount++;
                    // Find the temporary address for this family
                    const tempAddr = tempAddresses.find(t => t.userId.toString() === family._id.toString());
                    
                    // Pass tempAddr to createStopCard
                    listContainer.innerHTML += createStopCard(family, activeKids, tempAddr);
                    activeFamilies.push(family); // Add the family to the global list for routing

                    // Fetch messages for each active family
                    conversationPromises.push(fetchWithAuth(`/api/messages/${family._id}`));
                }
            });

            if (activeStopCount === 0) {
                if (emptyState) emptyState.classList.remove('d-none');
                generatePickupBtn.disabled = true;
                generateDropoffBtn.disabled = true;
            } else {
                // Once all families are processed, render the conversations
                processAndRenderConversations(conversationPromises, allFamilies);
                generatePickupBtn.disabled = false;
                generateDropoffBtn.disabled = false;
            }

        } catch (error) {
            console.error("Error loading route:", error);
            listContainer.innerHTML = `<div class="alert alert-danger">Error loading route data. Check server connection.</div>`;
        } finally {
            if (loading) loading.classList.add('d-none');
        }
    }

    // ---------------------------------------------------------
    // 2.5 ROUTE GENERATION FUNCTIONS
    // ---------------------------------------------------------

    function generatePickupRoute() {
        if (activeFamilies.length === 0) {
            alert('No active riders to generate a pickup route for.');
            return;
        }

        const churchAddress = "201 Catron St. Rural Retreat, VA, 24368";
        const waypoints = activeFamilies
            .map(family => {
                const tempAddr = tempAddresses.find(t => t.userId.toString() === family._id.toString());
                return encodeURIComponent(tempAddr && tempAddr.pickupAddress ? tempAddr.pickupAddress : family.address);
            })
            .join('|');

        const mapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(churchAddress)}&destination=${encodeURIComponent(churchAddress)}&waypoints=${waypoints}&travelmode=driving`;
        window.open(mapsUrl, '_blank');
    }

    function generateDropoffRoute() {
        if (activeFamilies.length === 0) {
            alert('No active riders to generate a dropoff route for.');
            return;
        }

        const churchAddress = "201 Catron St. Rural Retreat, VA, 24368";
        const waypoints = activeFamilies
            .map(family => {
                const tempAddr = tempAddresses.find(t => t.userId.toString() === family._id.toString());
                return encodeURIComponent(tempAddr && tempAddr.dropoffAddress ? tempAddr.dropoffAddress : family.address);
            }).join('|');

        const mapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(churchAddress)}&destination=${encodeURIComponent(churchAddress)}&waypoints=${waypoints}&travelmode=driving`;
        window.open(mapsUrl, '_blank');
    }

    async function processAndRenderConversations(promises, families) {
        const conversationsContainer = document.getElementById('conversations-list');
        conversationsContainer.innerHTML = ''; // Clear previous content
    
        const messageResponses = await Promise.all(promises);
        const conversations = [];
    
        for (const response of messageResponses) {
            if (response.ok) {
                const messages = await response.json();
                if (messages.length > 0) {
                    const familyId = messages[0].conversationId;
                    // An unread message is one that is not read AND was not sent by the current secretary/admin (localStorage.getItem('userId'))
                    const hasUnread = messages.some(m => !m.isRead && m.senderId.toString() !== localStorage.getItem('userId'));

                    conversations.push({
                        familyId: familyId,
                        messages: messages,
                        latestTimestamp: new Date(messages[messages.length - 1].timestamp),
                        hasUnread: hasUnread
                    });
                }
            }
        }
    
        // Sort conversations: unread first, then by most recent message
        conversations.sort((a, b) => {
            if (a.hasUnread !== b.hasUnread) return a.hasUnread ? -1 : 1;
            return b.latestTimestamp - a.latestTimestamp;
        });
    
        // Render the sorted conversations
        conversations.forEach(convo => {
            const family = families.find(f => f._id === convo.familyId);
            if (family) {
                conversationsContainer.innerHTML += createConversationCard(family, convo.messages, convo.hasUnread);
            }
        });
    
        // Re-add event listeners to all reply forms after rendering
        document.querySelectorAll('.reply-form').forEach(form => {
            form.addEventListener('submit', handleReply);
        });
        // Add event listeners for expanding conversations (to mark as read)
        addConversationEventListeners();
    }



    // ---------------------------------------------------------
    // 3. HTML GENERATOR (Modified for Secretary UI)
    // ---------------------------------------------------------

    function createStopCard(family, activeKids, tempAddressData = null) {
        const namesHtml = activeKids.map(kid => {
            // Student id fallback: if student._id missing, generate a fallback using family id + name
            const studentId = (kid._id && kid._id.toString && kid._id.toString()) || `${family._id}-${kid.name}`;
            const present = studentIsPresent(studentId);
            const classes = `kid-badge clickable ${present ? 'solid' : 'outline'}`;
            const title = present ? 'Click to mark as not on bus' : 'Click to mark as on bus';
            return `<span class="badge ${classes}" data-student-id="${studentId}" title="${title}" onclick="toggleStudentPresence('${studentId}', this)">${kid.name}</span>`;
        }).join(' ');

        let titleHtml = `<h5 class="card-title fw-bold">${family.parentName}</h5>`;
        let displayAddress = family.address;
        let mapDestinationAddress = family.address;
        let instructionsHtml = '';

        if (tempAddressData) {
            titleHtml = `<h5 class="card-title fw-bold">${family.parentName} <span class="badge bg-warning text-dark">Temp Address</span></h5>`;
            displayAddress = tempAddressData.pickupAddress;
            mapDestinationAddress = tempAddressData.pickupAddress; // Map to pickup address
            if (tempAddressData.dropoffAddress) {
                displayAddress += ` (Dropoff: ${tempAddressData.dropoffAddress})`;
            }
            if (tempAddressData.instructions) {
                // SECURITY FIX: Prevent XSS by not using innerHTML with user content.
                const instructionsDiv = document.createElement('div');
                instructionsDiv.className = 'alert alert-warning p-2 small';
                instructionsDiv.innerHTML = `<i class="bi bi-info-circle-fill me-2"></i>`; // This part is safe as it's static
                instructionsDiv.appendChild(document.createTextNode(tempAddressData.instructions)); // Safely append user text
                instructionsHtml = instructionsDiv.outerHTML;
            }
        }

        const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(mapDestinationAddress)}`;

        return `
        <div class="card shadow-sm stop-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    ${titleHtml}
                    <small class="text-muted">Route #${family.routeNumber || 1}</small>
                </div>
                
                <div class="mb-3">
                    <small class="text-muted text-uppercase" style="font-size: 0.75rem;">Picking Up:</small><br>
                    ${namesHtml}
                </div>
                
                <p class="card-text text-secondary mb-3">
                    <i class="bi bi-geo-alt-fill"></i> ${displayAddress}
                </p>
                ${instructionsHtml}

                <div class="row g-2">
                    <div class="col-6">
                        <a href="${mapUrl}" target="_blank" class="btn btn-outline-primary w-100">
                           <i class="bi bi-geo-alt-fill"></i> Map
                        </a>
                    </div>
                    <div class="col-6">
                        <a href="tel:${family.phoneNumber}" class="btn btn-outline-success w-100">
                            <i class="bi bi-telephone-fill"></i> Call
                        </a>
                    </div>
                </div>
            </div>
        </div>
        `;
    }

    function createConversationCard(family, messages, hasUnread) {
        const messageHtml = messages.map(msg => `
            <div class="p-2 rounded ${msg.senderName === 'Secretary' ? 'bg-light' : 'bg-white'} mb-1">
                <strong class="text-primary small">${msg.senderName}:</strong>
                <p class="mb-1">${msg.content}</p>
                <div class="text-muted small text-end" style="font-size: 0.75rem;">${new Date(msg.timestamp).toLocaleTimeString()}</div>
            </div>
        `).join('');

        const unreadClass = hasUnread ? 'unread' : '';
        const iconHtml = hasUnread
            ? `<i class="bi bi-envelope-fill envelope-icon envelope-unread"></i>`
            : `<i class="bi bi-envelope-open-fill envelope-icon envelope-read"></i>`;

        return `
            <div class="card shadow-sm mb-3 conversation-card ${hasUnread ? 'unread' : ''}" id="conversation-card-${family._id}">
                <div class="card-header fw-bold">
                    <a href="#collapse-${family._id}" class="text-decoration-none text-dark d-block" data-bs-toggle="collapse" aria-expanded="false" aria-controls="collapse-${family._id}" data-conversation-id="${family._id}">
                        <span class="icon-container">${iconHtml}</span>
                        <span>${family.parentName}</span>
                    </a>
                </div>
                <div class="collapse" id="collapse-${family._id}">
                    <div class="card-body bg-light" style="max-height: 250px; overflow-y: auto;">
                        ${messageHtml}
                    </div>
                    <div class="card-footer">
                        <form class="reply-form" data-conversation-id="${family._id}">
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="Type your reply..." required>
                                <button class="btn btn-outline-primary" type="submit">Send</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        `;
    }

    // ---------------------------------------------------------
    // 4. MESSAGING LOGIC
    // ---------------------------------------------------------

    async function fetchAndRenderAnnouncements() {
        const announcementsList = document.getElementById('announcements-list');
        try {
            const response = await fetchWithAuth('/api/messages/global');
            const announcements = await response.json();

            if (announcements.length === 0) {
                announcementsList.innerHTML = '<p class="text-muted small">No recent announcements found.</p>';
                return;
            }

            announcementsList.innerHTML = announcements
                .map(msg => {
                    // Determine if this announcement is a non-operational (Service Suspension)
                    const isNonOp = Boolean(msg.groupId) || (typeof msg.content === 'string' && msg.content.startsWith('Service Suspension'));
                    // Only show delete button for regular announcements; hide for non-op
                    const deleteButtonHtml = isNonOp 
                        ? '' 
                        : `<button class="btn btn-sm btn-outline-danger" onclick="deleteAnnouncement('${msg._id}')"><i class="bi bi-trash-fill"></i></button>`;
                    return `
                <div class="alert alert-info d-flex justify-content-between align-items-start" id="announcement-${msg._id}" data-nonop="${isNonOp}" data-groupid="${msg.groupId || ''}">
                    <div>
                        <p class="mb-1">${msg.content}</p>
                        <small class="text-muted">Sent on ${new Date(msg.timestamp).toLocaleDateString()}</small>
                    </div>
                    ${deleteButtonHtml}
                </div>
            `;
                }).join('');

        } catch (error) {
            announcementsList.innerHTML = '<p class="text-danger small">Could not load announcements.</p>';
        }
    }

    async function clearAnnouncements() {
        if (!confirm("Are you sure you want to delete all global announcements? This cannot be undone.")) {
            return;
        }
        // Fetch current announcements to determine if any are non-operational
        try {
            const resp = await fetchWithAuth('/api/messages/global');
            if (!resp.ok) return; // silently do nothing
            const anns = await resp.json();
            const hasNonOp = anns.some(m => Boolean(m.groupId) || (typeof m.content === 'string' && m.content.startsWith('Service Suspension')));
            if (hasNonOp) {
                // Per requirements, do nothing if any non-op messages would be affected
                return;
            }

            const response = await fetchWithAuth('/api/messages/global/clear', { method: 'POST' });
            if (response.ok) {
                fetchAndRenderAnnouncements(); // Refresh the list
            } else {
                // Silent no-op on failure per UX requirement for non-op messages
                return;
            }
        } catch (error) {
            // Silent no-op on network errors for this action
            return;
        }
    }

    function deleteAnnouncement(messageId) {
        // Set the ID and show the modal instead of using confirm()
        messageIdToDelete = messageId;
        confirmDeleteModal.show();
    }

    document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
        if (!messageIdToDelete) return;

        const deleteBtn = document.getElementById('confirm-delete-btn');
        deleteBtn.disabled = true;
        
        try {
            // If the announcement is a non-op message, silently do nothing
            const el = document.getElementById(`announcement-${messageIdToDelete}`);
            if (el && el.dataset && el.dataset.nonop === 'true') {
                confirmDeleteModal.hide();
                messageIdToDelete = null;
                deleteBtn.disabled = false;
                return;
            }

            const response = await fetchWithAuth(`/api/messages/${messageIdToDelete}`, { method: 'DELETE' });
            if (response.ok) {
                document.getElementById(`announcement-${messageIdToDelete}`).remove();
                confirmDeleteModal.hide();
            } else {
                // For non-op deletions the server may reject; per UX requirement silently do nothing
                confirmDeleteModal.hide();
            }
        } catch (error) {
            // Silent no-op on network errors for this delete action
            confirmDeleteModal.hide();
        } finally {
            deleteBtn.disabled = false;
            messageIdToDelete = null;
        }
    });

    async function sendGlobalMessage() {
        const text = document.getElementById('messageText').value.trim();
        const status = document.getElementById('globalMessageStatus');

        if (text.length < 5) {
            status.innerHTML = `<span class="text-danger">Message too short.</span>`;
            return;
        }

        const messageData = {
            conversationId: 'global',
            senderId: localStorage.getItem('userId'),
            senderName: 'Announcement', // Set a generic name for global broadcasts
            content: text
        };

        try {
            const response = await fetchWithAuth('/api/messages', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(messageData)
            });

            if (response.ok) {
                status.innerHTML = `<span class="text-success">Global announcement sent successfully!</span>`;
                document.getElementById('messageText').value = '';
                fetchAndRenderAnnouncements(); // Refresh the list
            } else {
                status.innerHTML = `<span class="text-danger">Failed to send message.</span>`;
            }
        } catch (error) {
            status.innerHTML = `<span class="text-danger">Network error.</span>`;
        }
    }

    async function handleReply(event) {
        event.preventDefault();
        const form = event.target;
        const conversationId = form.dataset.conversationId;
        const input = form.querySelector('input');
        const content = input.value.trim();

        if (!content) return;

        const messageData = {
            conversationId,
            senderId: localStorage.getItem('userId'),
            senderName: 'Secretary',
            content
        };

        // For simplicity, we just reload the whole route list to see the new message.
        // A more advanced implementation would append the message dynamically.
        await fetchWithAuth('/api/messages', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(messageData) });
        loadRoute();
    }

    function addConversationEventListeners() {
        // When a conversation is shown, mark its messages as read
        document.querySelectorAll('.collapse').forEach(el => {
            el.addEventListener('show.bs.collapse', async (event) => {
                const anchor = event.target.parentElement.querySelector('[data-bs-toggle="collapse"]');
                const conversationId = anchor.dataset.conversationId;
                const card = document.getElementById(`conversation-card-${conversationId}`);
                
                // Only proceed if the card has the 'unread' class
                if (card && card.classList.contains('unread')) {
                    await fetchWithAuth('/api/messages/mark-as-read', {
                        method: 'POST',
                        body: JSON.stringify({ conversationId })
                    });
                    // --- Update UI instantly ---
                    // 1. Remove the 'unread' class from the parent card
                    card.classList.remove('unread');
                    // 2. Find the icon and swap its classes
                    const iconContainer = card.querySelector('.icon-container');
                    if (iconContainer) {
                        iconContainer.innerHTML = `<i class="bi bi-envelope-open-fill envelope-icon envelope-read"></i>`;
                    }
                }
            });
        });
    }

    // Start loading the route when the page loads
    loadRoute();
</script>
<script>
    // Rider Invite Form Logic
    document.getElementById('invite-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const emailInput = document.getElementById('invite-email');
        const email = emailInput.value.trim();
        const statusEl = document.getElementById('invite-status');
        const submitButton = e.target.querySelector('button');

        statusEl.textContent = 'Sending...';
        statusEl.className = 'mt-2 text-center small text-muted';
        submitButton.disabled = true;

        try {
            const response = await fetchWithAuth('/api/invites', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email }),
            });
            const result = await response.json();
            statusEl.textContent = result.message;
            statusEl.className = response.ok ? 'mt-2 text-center small text-success' : 'mt-2 text-center small text-danger';
            if (response.ok) emailInput.value = '';
        } catch (error) {
            statusEl.textContent = 'A network error occurred.';
            statusEl.className = 'mt-2 text-center small text-danger';
        } finally {
            submitButton.disabled = false;
        }
    });
</script>

</body>
</html>