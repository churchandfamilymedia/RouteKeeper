<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RouteKeeper - Manage Users</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .container { max-width: 900px; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="admin-dashboard.html">
            <i class="bi bi-shield-lock-fill"></i> RouteKeeper Admin
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#adminNavbar">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="adminNavbar">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link" href="admin-dashboard.html">Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="admin-add-user.html">Add User</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="admin-manage-users.html">Manage Users</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">App Views</a>
                    <ul class="dropdown-menu dropdown-menu-dark">
                        <li><a class="dropdown-item" href="secretary.html">Secretary View</a></li>
                        <li><a class="dropdown-item" href="driver.html">Driver View</a></li>
                    </ul>
                </li>
            </ul>
            <button class="btn btn-sm btn-outline-light" onclick="logout()">Logout</button>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <div id="status-message" class="alert d-none" role="alert"></div>

    <h4 class="mb-3">Active User Accounts</h4>
    <div id="loading" class="text-center mt-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    <div class="accordion" id="user-roles-accordion">
        <!-- User roles will be dynamically injected here as accordion items -->
    </div>
    <p id="no-users-found" class="text-muted d-none">No active user accounts found.</p>

    <h4 class="mb-3 mt-5 pt-3 border-top">Recently Deleted Riders</h4>
    <p class="text-muted small">Users deleted within the last 30 days can be restored. After 30 days, their data will be permanently removed.</p>
    <div class="list-group" id="deleted-user-list">
        <!-- Deleted users will be dynamically injected here -->
        <p id="no-deleted-users-found" class="text-muted d-none">No recently deleted accounts found.</p>
    </div>
</div>

<footer class="text-center text-muted py-4">
    <small>&copy; Church and Family Media</small>
</footer>


<!-- Confirmation Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to deactivate the user <strong id="user-name-to-delete"></strong>?</p>
                <p class="text-warning small"><strong>Note:</strong> This will prevent the user from logging in. You can restore their account for up to 30 days.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">Yes, Delete User</button>
            </div>
        </div>
    </div>
</div>

<!-- Restore Confirmation Modal -->
<div class="modal fade" id="confirmRestoreModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Restore</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to restore the user <strong id="user-name-to-restore"></strong>?</p>
                <p class="small text-muted">Their account will be reactivated, and they will be able to log in again.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirm-restore-btn">Yes, Restore User</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Security Check
    if (localStorage.getItem('role') !== 'admin') {
        window.location.href = 'login.html';
    }

    function logout() {
        localStorage.clear();
        window.location.href = 'login.html';
    }

    // Centralized fetch function to handle authentication and errors
    async function fetchWithAuth(url, options = {}) {
        const token = localStorage.getItem('token');
        const headers = {
            ...options.headers,
            'Authorization': `Bearer ${token}`
        };

        if (options.body && !headers['Content-Type']) {
            headers['Content-Type'] = 'application/json';
        }

        const response = await fetch(url, { ...options, headers });

        if (response.status === 401 || response.status === 403) {
            logout(); // Token is invalid or expired, so log out.
        }
        return response;
    }

    const userAccordionContainer = document.getElementById('user-roles-accordion');
    const deletedUserListContainer = document.getElementById('deleted-user-list');
    const loadingSpinner = document.getElementById('loading');
    const statusMessage = document.getElementById('status-message');
    const confirmDeleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
    let userIdToDelete = null;

    const confirmRestoreModal = new bootstrap.Modal(document.getElementById('confirmRestoreModal'));
    const confirmRestoreBtn = document.getElementById('confirm-restore-btn');
    let userIdToRestore = null;

    async function loadUsers() {
        loadingSpinner.classList.remove('d-none');
        userAccordionContainer.innerHTML = '';

        try {
            // Fetch all users by not specifying a role
            const response = await fetchWithAuth('/api/users');
            if (!response.ok) throw new Error('Failed to fetch users.');
            
            const users = await response.json();

            if (users.length === 0) {
                document.getElementById('no-users-found').classList.remove('d-none');
                return;
            }

            // Group users by role
            const groupedByRole = users.reduce((acc, user) => {
                (acc[user.role] = acc[user.role] || []).push(user);
                return acc;
            }, {});

            // Define the order of roles
            const roleOrder = ['admin', 'secretary', 'driver', 'rider'];

            for (const role of roleOrder) {
                if (groupedByRole[role]) {
                    const usersInRole = groupedByRole[role];
                    let roleName;

                    if (role === 'secretary') {
                        roleName = 'Secretaries';
                    } else {
                        roleName = role.charAt(0).toUpperCase() + role.slice(1) + 's';
                    }
                    
                    const userListHtml = usersInRole.map(user => `
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${user.parentName}</h6>
                                <small class="text-muted">${user.username} - ${user.email}</small>
                            </div>
                            <button class="btn btn-sm btn-outline-danger" onclick="prepareDelete('${user._id}', '${user.parentName}')">
                                <i class="bi bi-person-x-fill"></i> Deactivate
                            </button>
                        </div>
                    `).join('');

                    const accordionItem = `
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading-${role}">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${role}">
                                    ${roleName} <span class="badge bg-secondary ms-2">${usersInRole.length}</span>
                                </button>
                            </h2>
                            <div id="collapse-${role}" class="accordion-collapse collapse">
                                <div class="list-group list-group-flush">
                                    ${userListHtml}
                                </div>
                            </div>
                        </div>
                    `;
                    userAccordionContainer.innerHTML += accordionItem;
                }
            }

        } catch (error) {
            userAccordionContainer.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
        } finally {
            loadingSpinner.classList.add('d-none');
        }
    }

    async function loadDeletedUsers() {
        deletedUserListContainer.innerHTML = '';
        try {
            // Fetch all deleted users
            const response = await fetchWithAuth('/api/users/deleted');
            if (!response.ok) throw new Error('Failed to fetch deleted users.');

            const users = await response.json();

            if (users.length === 0) {
                deletedUserListContainer.innerHTML = '<p class="text-muted">No recently deleted riders found.</p>';
                return;
            }

            users.forEach(user => {
                const deletionDate = new Date(user.deletionDate);
                const expiryDate = new Date(new Date(user.deletionDate).setDate(deletionDate.getDate() + 30));

                const userElement = document.createElement('div');
                userElement.className = 'list-group-item d-flex justify-content-between align-items-center bg-light';
                userElement.innerHTML = `
                    <div>
                        <span class="badge bg-secondary me-2">${user.role}</span>
                        <h5 class="mb-1 text-muted"><s>${user.parentName}</s></h5>
                        <small class="text-danger">Data will be permanently deleted on: ${expiryDate.toLocaleDateString()}</small>
                    </div>
                    <button class="btn btn-sm btn-outline-success" onclick="prepareRestore('${user._id}', '${user.parentName}')">
                        <i class="bi bi-arrow-counterclockwise"></i> Restore
                    </button>
                `;
                deletedUserListContainer.appendChild(userElement);
            });

        } catch (error) {
            deletedUserListContainer.innerHTML = `<div class="alert alert-warning">${error.message}</div>`;
        }
    }

    function prepareDelete(userId, userName) {
        userIdToDelete = userId;
        document.getElementById('user-name-to-delete').textContent = userName;
        confirmDeleteModal.show();
    }

    confirmDeleteBtn.addEventListener('click', async () => {
        if (!userIdToDelete) return;

        confirmDeleteBtn.disabled = true;
        

        try {
            const response = await fetchWithAuth(`/api/users/${userIdToDelete}`, {
                method: 'DELETE',
            });
            const result = await response.json();

            statusMessage.className = response.ok ? 'alert alert-success' : 'alert alert-danger';
            statusMessage.textContent = result.message;
            statusMessage.classList.remove('d-none');

            if (response.ok) {
                loadUsers(); // Refresh both lists
                loadDeletedUsers();
            }

        } catch (error) {
            statusMessage.className = 'alert alert-danger';
            statusMessage.textContent = 'A network error occurred. Could not delete user.';
            statusMessage.classList.remove('d-none');
        } finally {
            confirmDeleteBtn.disabled = false;
            confirmDeleteModal.hide();
            setTimeout(() => statusMessage.classList.add('d-none'), 5000);
        }
    });

    function prepareRestore(userId, userName) {
        userIdToRestore = userId;
        document.getElementById('user-name-to-restore').textContent = userName;
        confirmRestoreModal.show();
    }

    confirmRestoreBtn.addEventListener('click', async () => {
        if (!userIdToRestore) return;

        confirmRestoreBtn.disabled = true;

        try {
            const response = await fetchWithAuth(`/api/users/${userIdToRestore}/restore`, {
                method: 'PUT',
            });
            const result = await response.json();

            statusMessage.className = response.ok ? 'alert alert-success' : 'alert alert-danger';
            statusMessage.textContent = result.message;
            statusMessage.classList.remove('d-none');

            if (response.ok) {
                loadUsers(); // Refresh both lists
                loadDeletedUsers();
            }

        } catch (error) {
            statusMessage.className = 'alert alert-danger';
            statusMessage.textContent = 'A network error occurred. Could not restore user.';
            statusMessage.classList.remove('d-none');
        } finally {
            confirmRestoreBtn.disabled = false;
            confirmRestoreModal.hide();
            setTimeout(() => statusMessage.classList.add('d-none'), 5000);
        }
    });


    // Initial load
    document.addEventListener('DOMContentLoaded', () => {
        loadUsers();
        loadDeletedUsers();
    });
</script>

</body>
</html>