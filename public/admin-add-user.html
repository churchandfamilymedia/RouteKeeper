<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RouteKeeper - Add User</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        /* Target only the main content container, not the one in the navbar */
        .container {
            max-width: 900px; /* Standardized width for all containers on the page */
        }
        /* Apply bottom padding ONLY to the main content container to avoid affecting the navbar */
        .container.mt-4 {
            padding-bottom: 5rem; /* Adds space at the bottom of the page */
        }
        .student-entry {
            display: flex;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="admin-dashboard.html">
            <i class="bi bi-shield-lock-fill"></i> RouteKeeper Admin
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#adminNavbar">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="adminNavbar">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link" href="admin-dashboard.html">Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="admin-add-user.html">Add User</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="admin-manage-users.html">Manage Users</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">App Views</a>
                    <ul class="dropdown-menu dropdown-menu-dark">
                        <li><a class="dropdown-item" href="secretary.html">Secretary View</a></li>
                        <li><a class="dropdown-item" href="driver.html">Driver View</a></li>
                    </ul>
                </li>
            </ul>
            <button class="btn btn-sm btn-outline-light" onclick="logout()">Logout</button>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <div id="statusMessage" class="alert d-none"></div>

    <form id="addUserForm">
        <h4 class="mb-3">Core Details</h4>
        <div class="mb-3">
            <label for="role" class="form-label">User Role</label>
            <select class="form-select" id="role" required onchange="toggleFields()">
                <option value="" disabled selected>Select Role</option>
                <option value="rider">Rider (Parent/Family)</option>
                <option value="tempRider">Temp Rider (Roster only - no account)</option>
                <option value="driver">Driver</option>
                <option value="secretary">Secretary</option>
                <option value="admin">Administrator</option>
            </select>
        </div>

        <div class="mb-3">
            <label for="parentName" class="form-label">Full Name</label>
            <input type="text" class="form-control" id="parentName" required>
        </div>

        <div id="accountFields">
            <div class="mb-3">
                <label for="username" class="form-label">Username</label>
                <input type="text" class="form-control" id="username" required>
            </div>

            <div class="mb-3">
                <label for="email" class="form-label">Email Address</label>
                <input type="email" class="form-control" id="email" required>
            </div>

            <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <input type="password" class="form-control" id="password" required>
            </div>
        </div>

        <hr>
        
        <div id="riderFields" class="d-none">
            <h4 class="mb-3">Rider Details</h4>
            
            <div class="mb-3">
                <label for="phoneNumber" class="form-label">Phone Number</label>
                <input type="text" class="form-control" id="phoneNumber">
            </div>

            <div class="mb-3">
                <label for="address" class="form-label">Pickup Address</label>
                <input type="text" class="form-control" id="address">
            </div>

            <h5 class="mt-4 mb-2">Students</h5>
            <div id="studentsContainer">
                <div class="student-entry">
                    <input type="text" class="form-control student-name-input" placeholder="Student Name" required>
                </div>
            </div>
            <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="addStudentField()">Add Another Student</button>
            
            <hr>
        </div>

        <button type="submit" class="btn btn-primary w-100">Create User</button>
    </form>
</div>

<footer class="text-center text-muted py-4">
    <small>&copy; Church and Family Media</small>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ---------------------------------------------------------
    // 1. SECURITY & UTILITY
    // ---------------------------------------------------------
    
    // Require a valid token and admin role to access this page
    const token = localStorage.getItem('token');
    const role = localStorage.getItem('role');
    if (!token || role !== 'admin') {
        localStorage.clear();
        window.location.href = '/index.html';
    }

    function logout() {
        localStorage.clear();
    window.location.href = '/index.html';
    }

    const riderFields = document.getElementById('riderFields');

    // Toggles the visibility of Rider-specific fields
    function toggleFields() {
        const selectedRole = document.getElementById('role').value;
        const studentInputs = document.querySelectorAll('.student-name-input');
        const accountFields = document.getElementById('accountFields');

        if (selectedRole === 'rider' || selectedRole === 'tempRider') {
            riderFields.classList.remove('d-none');
            // Make student inputs required only when the role is rider
                studentInputs.forEach(input => input.required = true);
            // For a normal rider require account fields; for tempRider hide them
            if (selectedRole === 'rider') {
                if (accountFields) accountFields.style.display = '';
                const uname = document.getElementById('username'); if (uname) uname.required = true;
                const mail = document.getElementById('email'); if (mail) mail.required = true;
                const pass = document.getElementById('password'); if (pass) pass.required = true;
            } else {
                if (accountFields) accountFields.style.display = 'none';
                const uname = document.getElementById('username'); if (uname) uname.required = false;
                const mail = document.getElementById('email'); if (mail) mail.required = false;
                const pass = document.getElementById('password'); if (pass) pass.required = false;
            }
        } else {
            riderFields.classList.add('d-none');
            // Remove the required attribute for other roles to prevent validation errors
            studentInputs.forEach(input => input.required = false);
            if (accountFields) accountFields.style.display = '';
            const uname = document.getElementById('username'); if (uname) uname.required = true;
            const mail = document.getElementById('email'); if (mail) mail.required = true;
            const pass = document.getElementById('password'); if (pass) pass.required = true;
        }
    }

    // Adds a new input field for a student name
    function addStudentField() {
        const container = document.getElementById('studentsContainer');
        const newEntry = document.createElement('div');
        newEntry.classList.add('student-entry');
        
        newEntry.innerHTML = `
            <input type="text" class="form-control student-name-input" placeholder="Student Name" required>
            <button type="button" class="btn btn-outline-danger btn-sm ms-2" onclick="removeStudentField(this)">Remove</button>
        `;
        container.appendChild(newEntry);
    }
    
    // Removes a student input field
    function removeStudentField(button) {
        button.closest('.student-entry').remove();
    }


    // ---------------------------------------------------------
    // 2. FORM SUBMISSION
    // ---------------------------------------------------------

    document.getElementById('addUserForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const role = document.getElementById('role').value;
        const username = document.getElementById('username') ? document.getElementById('username').value : '';
        const password = document.getElementById('password') ? document.getElementById('password').value : '';
        const email = document.getElementById('email') ? document.getElementById('email').value : '';
        
        let students = [];

        // Collect data specific to the Rider role
        if (role === 'rider') {
            const studentInputs = document.querySelectorAll('#studentsContainer .student-name-input');
            
            studentInputs.forEach(input => {
                if (input.value.trim()) {
                    students.push({ name: input.value.trim() });
                }
            });

            // Require at least one student for a rider
            if (students.length === 0) {
                alert('Rider accounts require at least one student name.');
                return;
            }
        }

        const userData = {
            username: username,
            email: email,
            password: password,
            role: role,
            parentName: document.getElementById('parentName').value // Collect Full Name for all roles
        };

        // Add fields specific to the 'rider' role or tempRider roster entry
        if (role === 'rider' || role === 'tempRider') {
            userData.phoneNumber = document.getElementById('phoneNumber').value;
            userData.address = document.getElementById('address').value;
            userData.students = students;
        }

        const statusMessage = document.getElementById('statusMessage');
        statusMessage.classList.add('d-none'); // Hide previous message

        try {
            let response;
            if (role === 'tempRider') {
                // Create a roster-only TempRider entry (no account)
                // This endpoint requires an Authorization token (admin only)
                const token = localStorage.getItem('token');
                if (!token) {
                    statusMessage.classList.remove('d-none');
                    statusMessage.classList.remove('alert-success');
                    statusMessage.classList.add('alert-danger');
                    statusMessage.innerText = 'Error: You must be signed in to create Temp Riders.';
                    return;
                }

                response = await fetch('/api/temp-riders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ parentName: userData.parentName, phoneNumber: userData.phoneNumber, address: userData.address, students: userData.students })
                });
            } else {
                response = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });
            }

            const result = await response.json();

            if (response.ok) {
                statusMessage.classList.remove('alert-danger');
                statusMessage.classList.add('alert-success');
                statusMessage.innerText = `Success: ${result.message}`;
                document.getElementById('addUserForm').reset(); // Clear the form
                toggleFields(); // Hide rider fields after reset

            } else {
                statusMessage.classList.remove('alert-success');
                statusMessage.classList.add('alert-danger');
                statusMessage.innerText = `Error: ${result.message || response.statusText}`;
            }

        } catch (error) {
            statusMessage.classList.remove('alert-success');
            statusMessage.classList.add('alert-danger');
            statusMessage.innerText = `Network error: Could not connect to the server.`;
            console.error('Registration fetch error:', error);
        }
        
        statusMessage.classList.remove('d-none');
    });

    // Initialize state on load
    toggleFields();
</script>

</body>
</html>